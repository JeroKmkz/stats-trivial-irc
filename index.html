<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Procesador de Logs de Trivial IRC ‚Äî V15+GP</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
    .container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #333; text-align: center; margin-bottom: 30px; }
    .upload-section { border: 2px dashed #ddd; padding: 40px; text-align: center; margin-bottom: 30px; border-radius: 8px; background-color: #fafafa; }
    .upload-section:hover { border-color: #007bff; background-color: #f0f8ff; }
    input[type="file"] { margin: 20px 0; }
    .button { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px; }
    .button:hover { background-color: #0056b3; }
    .button:disabled { background-color: #ccc; cursor: not-allowed; }
    .results { margin-top: 30px; }
    .team-section { margin-bottom: 30px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .team-header { padding: 15px; font-weight: bold; font-size: 18px; text-align: center; }
    .stats-table { width: 100%; border-collapse: collapse; }
    .stats-table th, .stats-table td { padding: 8px 12px; text-align: center; border: 1px solid #ddd; }
    .stats-table th { background-color: #f8f9fa; font-weight: bold; }
    .player-row { background-color: white; }
    .error { color: #dc3545; background-color: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .success { color: #155724; background-color: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .log-info { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .competition-select { text-align: center; margin-bottom: 30px; }
    .competition-select label { font-weight: bold; margin-right: 10px; }
    .gp-number-select { text-align: center; margin-bottom: 20px; }
    .gp-number-select label { font-weight: bold; margin-right: 10px; }
    select { padding: 6px 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Procesador de Logs de Trivial IRC</h1>

    <!-- SELECCI√ìN DE COMPETICI√ìN -->
    <div class="competition-select">
      <label for="competitionSelect">Tipo de competici√≥n:</label>
      <select id="competitionSelect">
        <option value="liga" selected>Liga</option>
        <option value="gp">GP</option>
        <option value="copa" disabled>Copa (pr√≥x.)</option>
        <option value="relevos" disabled>Torneo Relevos (pr√≥x.)</option>
        <option value="master" disabled>M√°ster por Equipos (pr√≥x.)</option>
        <option value="posiciones" disabled>Torneo Posiciones (pr√≥x.)</option>
      </select>
    </div>

    <!-- SELECCI√ìN DEL N√öMERO DE GP (solo visible cuando se selecciona GP) -->
    <div class="gp-number-select" id="gpNumberDiv" style="display: none;">
      <label for="gpNumberSelect">N√∫mero de GP:</label>
      <select id="gpNumberSelect">
        <option value="1" selected>GP1</option>
        <option value="2">GP2</option>
        <option value="3">GP3</option>
        <option value="4">GP4</option>
        <option value="5">GP5</option>
        <option value="6">GP6</option>
        <option value="7">GP7</option>
        <option value="8">GP8</option>
      </select>
    </div>

    <!-- PROCESO 1: Estad√≠sticas de la Jornada -->
    <div class="upload-section">
      <h3>üìä Estad√≠sticas de la Jornada</h3>
      <p>Sube los logs (.txt) de las partidas de una jornada espec√≠fica</p>
      <input type="file" id="fileInputJornada" accept=".txt" multiple />
      <br />
      <button class="button" onclick="processJornada()" id="processJornadaBtn" disabled>Procesar Jornada</button>
    </div>

    <!-- PROCESO 2: Totales y Medias Liga (solo visible en modo Liga) -->
    <div class="upload-section" id="totalesSection" style="border-color: #28a745; background-color: #f8fff9;">
      <h3>üèÜ Totales y Medias Liga</h3>
      <p>Sube los Excels (.xlsx) generados de cada jornada para obtener totales acumulados</p>
      <input type="file" id="fileInputTotales" accept=".xlsx" multiple />
      <br />
      <button class="button" onclick="processTotales()" id="processTotalesBtn" disabled style="background-color: #28a745;">Generar Totales Liga</button>
    </div>

    <div id="results" class="results" style="display: none;"></div>

    <div id="downloadSection" style="display: none; text-align: center; margin-top: 30px;">
      <button class="button" onclick="downloadExcel()" id="downloadBtn">üì• Descargar Excel</button>
    </div>
  </div>

  <script>
    // ===== Variables globales =====
    const COLORES_EQUIPOS = {
      "FOGUETES": {"bg": "#009F9F", "fg": "#00FF00"},
      "ATIPIK@S": {"bg": "#00FF00", "fg": "#0000FF"},
      "REPESCA@S": {"bg": "#C000C0", "fg": "#00FF00"},
      "DARKSHADOWS": {"bg": "#000000", "fg": "#808080"},
      "TELERINEZ": {"bg": "#000000", "fg": "#00FFFF"},
      "KAMIKAZES": {"bg": "#000000", "fg": "#FF0000"},
      "HARDBE@TS": {"bg": "#000000", "fg": "#FFFF00"},
      "LIDERES": {"bg": "#C000C0", "fg": "#FFFFFF"}
    };

    const COLORES_SUAVES = {
      "FOGUETES": {"bg": "#B3E5E5", "fg": "#006666"},
      "ATIPIK@S": {"bg": "#B3FFB3", "fg": "#006600"},
      "REPESCA@S": {"bg": "#E6B3E6", "fg": "#660066"},
      "DARKSHADOWS": {"bg": "#CCCCCC", "fg": "#333333"},
      "TELERINEZ": {"bg": "#E6F7F7", "fg": "#006666"},
      "KAMIKAZES": {"bg": "#FFE6E6", "fg": "#990000"},
      "HARDBE@TS": {"bg": "#FFFACD", "fg": "#B8860B"},
      "LIDERES": {"bg": "#F0E6F0", "fg": "#663366"}
    };

    let processedData = [];
    let fileNames = [];
    let currentProcess = '';
    let competitionType = 'liga';
    let gpNumber = 1;

    // ===== Inicializaci√≥n =====
    document.addEventListener('DOMContentLoaded', () => {
      const inJ = document.getElementById('fileInputJornada');
      const inT = document.getElementById('fileInputTotales');
      const bJ = document.getElementById('processJornadaBtn');
      const bT = document.getElementById('processTotalesBtn');
      const select = document.getElementById('competitionSelect');
      const gpSelect = document.getElementById('gpNumberSelect');
      const gpDiv = document.getElementById('gpNumberDiv');
      const totalesSection = document.getElementById('totalesSection');

      if (inJ) inJ.addEventListener('change', () => { 
        bJ.disabled = !(inJ.files && inJ.files.length); 
        fileNames = inJ.files? Array.from(inJ.files).map(f=>f.name):[]; 
        currentProcess='jornada'; 
      });
      
      if (inT) inT.addEventListener('change', () => { 
        bT.disabled = !(inT.files && inT.files.length); 
        fileNames = inT.files? Array.from(inT.files).map(f=>f.name):[]; 
        currentProcess='totales'; 
      });

      if (select) select.addEventListener('change', () => {
        competitionType = select.value;
        // Mostrar/ocultar selector de GP
        if (competitionType === 'gp') {
          gpDiv.style.display = 'block';
          totalesSection.style.display = 'none';
        } else {
          gpDiv.style.display = 'none';
          totalesSection.style.display = 'block';
        }
        // Bot√≥n de totales solo tiene sentido en Liga
        bT.disabled = (competitionType !== 'liga') || !(inT.files && inT.files.length);
      });

      if (gpSelect) gpSelect.addEventListener('change', () => {
        gpNumber = parseInt(gpSelect.value);
      });
    });

    function showError(msg){ const res=document.getElementById('results'); res.innerHTML=`<div class="error">${msg}</div>`; res.style.display='block'; }
    function showSuccess(msg){ const res=document.getElementById('results'); res.innerHTML=`<div class="success">${msg}</div>`; res.style.display='block'; }

    // ===== Helpers ExcelJS / Texto =====
    function xlsToString(v){ if (v == null) return ''; if (typeof v === 'string') return v; if (typeof v === 'number') return String(v); if (v.richText) return v.richText.map(t=>t.text).join(''); if (v.text) return v.text; if (v.result != null) return xlsToString(v.result); return String(v); }
    function norm(v){ return xlsToString(v).trim().toUpperCase(); }
    function numOrNull(v){ const s = xlsToString(v).replace(',','.').trim(); if(!s) return null; const n=Number(s); return Number.isFinite(n)?n:null; }

    // Ocultar cuadr√≠cula (dejando encabezados)
    function createWorksheetNoGrid(workbook, name){
      const ws = workbook.addWorksheet(name);
      ws.views = [{ state: 'normal', showGridLines: false }];
      return ws;
    }

    // Conversi√≥n aprox. px -> ancho Excel
    const PX_PER_CHAR = 7;
    const widthFromPx = (px) => +(px / PX_PER_CHAR).toFixed(2);
    const NAME_W = widthFromPx(121); // 121 px para "NOMBRE" (Liga)

    // ====== Comparador de nicks (Liga): s√≠mbolos antes que 'A' ======
    function normalizeNick(nick){ return String(nick||'').trim().toUpperCase().normalize('NFD').replace(/\p{Diacritic}+/gu,''); }
    function nickKey(nick){ const s = normalizeNick(nick); const first = s.charAt(0); const isLetter = /^[A-Z√ë]$/.test(first); return (isLetter ? '1' : '0') + s; }
    function cmpNick(a,b){ const A = nickKey(a), B = nickKey(b); return A.localeCompare(B,'es',{sensitivity:'base',numeric:true}); }

    // Marco com√∫n: fila arriba/abajo + columna izquierda/derecha
    function addFraming(ws, padWidth){
      if (Array.isArray(ws.columns) && ws.columns.length){
        const width = padWidth ?? ws.columns[0]?.width ?? 2.25;
        
        // Columna izquierda (√≠ndice 0)
        if (!ws.columns[0] || ws.columns[0].width === undefined) {
          ws.columns[0] = { width };
        }
        
        // Columna derecha
        ws.columns.push({ width });
        
        // Fila superior
        const topRow = ws.getRow(1);
        topRow.height = 7.5;
        
        // Fila inferior (encontrar la √∫ltima fila con datos)
        let lastRow = 1;
        for (let i = 1; i <= 100; i++) {
          const row = ws.getRow(i);
          if (row.values && row.values.some(v => v !== null && v !== undefined && v !== '')) {
            lastRow = i;
          }
        }
        const bottomRow = ws.getRow(lastRow + 1);
        bottomRow.height = 7.5;
      }
    }

    // ====== PROCESO 1: Jornada ======
    function processJornada(){
      const files = document.getElementById('fileInputJornada').files;
      if (!files || files.length === 0) return showError('Selecciona al menos un archivo de log');
      processedData = []; let processed = 0;
      Array.from(files).forEach((file, index)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const content = e.target.result;
            const data = parseLogFile(content);
            processedData[index] = data;
            processed++;
            if (processed === files.length){
              displayResults(processedData);
              document.getElementById('downloadSection').style.display='block';
              showSuccess(`${files.length} archivo${files.length>1?'s':''} de log procesado${files.length>1?'s':''} correctamente`);
            }
          }catch(err){ showError(`Error al procesar ${file.name}: ${err.message}`); }
        };
        reader.readAsText(file);
      });
    }

    // ====== PROCESO 2: Totales LIGA ======
    async function processTotales(){
      const files = document.getElementById('fileInputTotales').files;
      if (!files || files.length === 0) return showError('Selecciona al menos un archivo Excel (.xlsx)');
      try{
        processedData = []; fileNames = Array.from(files).map(f=>f.name);
        for (const file of files){
          const buffer = await file.arrayBuffer();
          const workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(buffer);
          const worksheet =
            workbook.getWorksheet('Estad√≠sticas') ||
            workbook.getWorksheet('Estadisticas') ||
            workbook.worksheets.find(ws => (ws.name||'').toLowerCase().includes('estadist'));
          if (!worksheet){ showError(`El archivo ${file.name} no tiene hoja 'Estad√≠sticas'`); return; }
          const matchData = extractDataFromExcel(worksheet);
          processedData.push(...matchData);
        }
        if (processedData.length === 0){
          showError("No se localizaron partidas en 'Estad√≠sticas'. Revisa que la fila de cabecera contenga PUNTOS/SCR y que no haya celdas combinadas extra√±as.");
          return;
        }
        displayTotalesOnlyResults();
        document.getElementById('downloadSection').style.display='block';
        showSuccess(`${fileNames.length} archivo${fileNames.length>1?'s':''} de jornada procesado${fileNames.length>1?'s':''} correctamente`);
      }catch(err){ showError('Error procesando archivos Excel: '+err.message); }
    }

    // ===== Parse log file =====
    function parseLogFile(content){
      const lines = content.split('\n').map(l=>l.trim()).filter(Boolean);
      const teamStart = lines.findIndex(l=>l.includes('CLASIFICACION EQUIPOS'));
      const playerStart = lines.findIndex(l=>l.includes('CLASIFICACION INDIVIDUAL'));
      if (teamStart === -1 || playerStart === -1) throw new Error('Secciones no encontradas');
      
      const teams = {}; const teamOrder = [];
      for (let i=teamStart+1; i<playerStart; i++){
        const m = /^(.*?)\s+(-?\d+)\s*$/.exec(lines[i]);
        if (!m) continue; 
        const team=m[1].trim(); 
        const points=parseInt(m[2],10);
        teams[team]=points; 
        teamOrder.push(team);
      }
      
      const players = [];
      for (let i=playerStart+1; i<lines.length; i++){
        const line = lines[i]; 
        const parts=line.split(/\s+/); 
        if (parts.length<2) continue;
        const name=parts[0]; 
        const points=parseInt(parts[1],10);
        players.push({
          name: name.toUpperCase(),
          points: line.includes('NO ESTUVO PRESENTE') ? null : points,
          aces: parseInt((line.match(/Aces:\s*(\d+)/) || [0,0])[1],10),
          scratches: parseInt((line.match(/Scr:\s*(\d+)/) || [0,0])[1],10),
          palos: parseInt((line.match(/Palos:\s*(\d+)/) || [0,0])[1],10),
          absent: line.includes('NO ESTUVO PRESENTE')
        });
      }
      
      // Asignar equipos a jugadores alfab√©ticamente
      const teamNames = Object.keys(teams).sort();
      let index=0, lastInitial='';
      players.forEach(p=>{ 
        const initial=p.name.charAt(0).toUpperCase(); 
        if (initial<lastInitial) index++; 
        p.team=teamNames[index]||'SinEquipo'; 
        lastInitial=initial; 
      });
      
      return { teams, teamOrder: teamOrder.sort((a,b)=>teams[b]-teams[a]), players };
    }

    // ===== Helper extracci√≥n Excel =====
    function findHeaderStartCol(row){
      const n = row.actualCellCount || row.cellCount || 100;
      for (let c=1; c<=n; c++){
        const cVal = norm(row.getCell(c).value);
        const next = norm(row.getCell(c+1).value);
        const isP = (cVal==='PUNTOS' || cVal==='PUNT.');
        const isS = (next==='SCRATCHES' || next==='SCR');
        if (isP && isS) return c;
      }
      return -1;
    }

    function extractDataFromExcel(worksheet){
      const matches = []; let currentRow = 1; const maxR = worksheet.rowCount || 10000;
      while (currentRow <= maxR){
        const row = worksheet.getRow(currentRow);
        const startCol = findHeaderStartCol(row);
        if (startCol !== -1){
          const m = extractSingleMatch(worksheet, currentRow, startCol);
          if (m) matches.push(m);
          currentRow += 14;
        } else { currentRow++; }
      }
      return matches;
    }

    function extractSingleMatch(worksheet, startRow, startCol){
      try{
        const teamRow = worksheet.getRow(startRow + 1);
        const teams = {}; const teamOrder = []; const players = [];
        let col = Math.max(1, startCol - 1);
        const maxC = worksheet.columnCount || 60;
        while (col <= maxC){
          const teamName = xlsToString(teamRow.getCell(col).value).trim();
          if (!teamName) break;
          const teamPoints = numOrNull(teamRow.getCell(col + 1).value);
          teams[teamName] = teamPoints ?? 0; teamOrder.push(teamName);
          for (let r = startRow + 2; r < startRow + 12; r++){
            const row = worksheet.getRow(r);
            const name = xlsToString(row.getCell(col).value).trim();
            if (!name) continue;
            const pPoints = numOrNull(row.getCell(col + 1).value);
            const pScr    = numOrNull(row.getCell(col + 2).value) ?? 0;
            const pPalos  = numOrNull(row.getCell(col + 3).value) ?? 0;
            const pAces   = numOrNull(row.getCell(col + 4).value) ?? 0;
            const absent = (pPoints === null);
            players.push({ name: name.toUpperCase(), team: teamName, points: absent ? null : pPoints, scratches: absent ? 0 : pScr, palos: absent ? 0 : pPalos, aces: absent ? 0 : pAces, absent });
          }
          col += 6;
        }
        return { teams, teamOrder, players };
      }catch(e){ console.error('extractSingleMatch error', e); return null; }
    }

    // ===== Vistas =====
    function displayResults(allData){
      const resultsDiv = document.getElementById('results'); 
      resultsDiv.innerHTML = '';
      
      if (competitionType === 'gp') {
        // Vista GP
        const allPlayers = new Set();
        allData.forEach(data => {
          data.players.forEach(player => {
            if (!player.absent) allPlayers.add(player.name);
          });
        });

        const info = document.createElement('div'); 
        info.className = 'log-info';
        info.innerHTML = `<h3>üèÅ GP${gpNumber} Procesado</h3>
          <p><strong>Grupos procesados:</strong> ${allData.length}</p>
          <p><strong>Jugadores √∫nicos:</strong> ${allPlayers.size}</p>
          <p><em>Se generar√° Excel con clasificaci√≥n de puntos GP</em></p>`;
        resultsDiv.appendChild(info); 
        resultsDiv.style.display='block';
      } else {
        // Vista Liga original
        const info = document.createElement('div'); 
        info.className = 'log-info';
        let totalTeams = 0, totalPlayers = 0;
        allData.forEach(d => { totalTeams += d.teamOrder.length; totalPlayers += d.players.length; });
        info.innerHTML = `<h3>üìä Informaci√≥n de los Logs</h3>
          <p><strong>Partidas procesadas:</strong> ${allData.length}</p>
          <p><strong>Total de equipos:</strong> ${totalTeams}</p>
          <p><strong>Total de jugadores:</strong> ${totalPlayers}</p>`;
        resultsDiv.appendChild(info);

        allData.forEach((data, matchIndex)=>{
          const matchDiv = document.createElement('div');
          matchDiv.style.marginBottom='40px'; matchDiv.style.border='2px solid #ddd';
          matchDiv.style.borderRadius='8px'; matchDiv.style.padding='20px';
          const matchTitle = document.createElement('h3');
          matchTitle.textContent = `Partida ${matchIndex+1}`;
          matchTitle.style.textAlign='center'; matchTitle.style.marginBottom='20px';
          matchDiv.appendChild(matchTitle);
          data.teamOrder.forEach(team=>{
            const players = data.players.filter(p=>p.team===team).sort((a,b)=>{
              if (a.absent && !b.absent) return 1; if (!a.absent && b.absent) return -1; return (b.points||0)-(a.points||0);
            });
            const teamDiv = document.createElement('div'); teamDiv.className='team-section';
            const colors = COLORES_EQUIPOS[team] || { bg:'#ccc', fg:'#000' };
            const header = document.createElement('div'); header.className='team-header';
            header.style.backgroundColor = colors.bg; header.style.color = colors.fg;
            header.textContent = `${team} - ${data.teams[team]} puntos`;
            teamDiv.appendChild(header);
            const table = document.createElement('table'); table.className='stats-table';
            table.innerHTML = `<tr><th></th><th>Puntos</th><th>Scratches</th><th>Palos</th><th>Aces</th></tr>`;
            players.forEach(p=>{
              const row = document.createElement('tr'); row.className='player-row';
              row.innerHTML = `
                <td style="text-align:left;font-weight:bold;">${p.name}</td>
                <td>${p.absent? '': p.points}</td>
                <td>${p.absent? '': p.scratches}</td>
                <td>${p.absent? '': p.palos}</td>
                <td>${p.absent? '': p.aces}</td>`;
              table.appendChild(row);
            });
            teamDiv.appendChild(table); matchDiv.appendChild(teamDiv);
          });
          resultsDiv.appendChild(matchDiv);
        });
        resultsDiv.style.display='block';
      }
    }

    function displayTotalesOnlyResults(){
      const resultsDiv = document.getElementById('results'); 
      resultsDiv.innerHTML='';
      const allPlayers = new Set(); 
      let totalMatches = processedData.length;
      processedData.forEach(m => m.players.forEach(p => allPlayers.add(p.name)));
      const info = document.createElement('div'); 
      info.className='log-info';
      info.innerHTML = `<h3>üèÜ Totales Liga Procesados</h3>
        <p><strong>Jornadas procesadas:</strong> ${fileNames.length}</p>
        <p><strong>Partidas totales:</strong> ${totalMatches}</p>
        <p><strong>Jugadores √∫nicos:</strong> ${allPlayers.size}</p>
        <p><em>Pulsa "Descargar Excel" para generar el acumulado</em></p>`;
      resultsDiv.appendChild(info); 
      resultsDiv.style.display='block';
    }

    // ===== Generaci√≥n Excel =====
    async function downloadExcel(){
      if (!processedData || processedData.length === 0) return showError('No hay datos procesados');
      try{
        const wb = new ExcelJS.Workbook();
        
        if (competitionType === 'gp') {
          const ws = createWorksheetNoGrid(wb, `GP${gpNumber}`);
          generateGpSheet(ws);
        } else if (currentProcess === 'jornada'){
          const ws = createWorksheetNoGrid(wb, 'Estad√≠sticas');
          generateJornadaSheet(ws);
        } else if (currentProcess === 'totales'){
          const ws = createWorksheetNoGrid(wb, 'Totales');
          generateTotalesSheet(ws);
        }

        const buffer = await wb.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a=document.createElement('a'); 
        a.href=url;
        
        if (competitionType === 'gp'){
          a.download = `GP${gpNumber}_${new Date().toISOString().slice(0,10)}.xlsx`;
        } else if (currentProcess==='jornada'){
          const base = fileNames.map(n=>n.replace(/\.txt$/,'')).join('_');
          a.download = `Jornada_${base}.xlsx`;
        } else {
          a.download = `Totales_Liga_${new Date().toISOString().slice(0,10)}.xlsx`;
        }
        
        a.click(); 
        URL.revokeObjectURL(url);
        showSuccess(`Excel generado correctamente`);
      }catch(err){ 
        console.error(err); 
        showError('Error generando Excel: '+err.message); 
      }
    }

    // ===== Generaci√≥n hojas espec√≠ficas =====
    function generateJornadaSheet(ws){
      let currentRow = 1;
      processedData.forEach(matchData => {
        const teams = matchData.teamOrder.map(teamName => ({
          name: teamName,
          points: matchData.teams[teamName],
          players: matchData.players.filter(p=>p.team===teamName).sort((a,b)=>{
            if (a.absent && !b.absent) return 1; 
            if(!a.absent && b.absent) return -1; 
            return (b.points||0)-(a.points||0);
          }),
          colors: COLORES_EQUIPOS[teamName] || { bg:'#CCCCCC', fg:'#000000' }
        }));

        const teamTotals = teams.map(t=>{ 
          const tt={scratches:0, palos:0, aces:0}; 
          t.players.forEach(p=>{ 
            if(!p.absent){ 
              tt.scratches+=p.scratches; 
              tt.palos+=p.palos; 
              tt.aces+=p.aces; 
            } 
          }); 
          return tt; 
        });

        const hdr = [''];
        teams.forEach((t,i)=>{ 
          hdr.push(''); 
          hdr.push('Puntos'); 
          hdr.push('Scratches'); 
          hdr.push('Palos'); 
          hdr.push('Aces'); 
          if(i<teams.length-1) hdr.push(''); 
        });
        ws.getRow(currentRow).values = hdr;

        const tot = [''];
        teams.forEach((t,i)=>{ 
          tot.push(t.name); 
          tot.push(t.points); 
          tot.push(teamTotals[i].scratches); 
          tot.push(teamTotals[i].palos); 
          tot.push(teamTotals[i].aces); 
          if(i<teams.length-1) tot.push(''); 
        });
        ws.getRow(currentRow+1).values = tot;

        let col=2; 
        teams.forEach((t,ti)=>{
          for(let i=0;i<5;i++){ 
            const c=ws.getCell(currentRow, col+i); 
            c.font={bold:false,size:13}; 
            c.alignment={horizontal:'center',vertical:'center'}; 
            c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; 
          }
          for(let i=0;i<5;i++){ 
            const c=ws.getCell(currentRow+1, col+i); 
            if(i===0){ 
              c.fill={type:'pattern',pattern:'solid',fgColor:{argb:t.colors.bg.replace('#','FF')}}; 
              c.font={color:{argb:t.colors.fg.replace('#','FF')},bold:true,size:14}; 
            } else if (i===1){ 
              c.font={bold:true,size:12}; 
            } else { 
              c.font={bold:false,size:12}; 
            } 
            c.alignment={horizontal:'center',vertical:'center'}; 
            c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; 
          }
          col += (ti<teams.length-1)?6:5;
        });

        for(let i=0;i<10;i++){
          const r = currentRow+2+i; 
          const hasAny = teams.some(t=>i<t.players.length); 
          if(!hasAny) continue;
          const row=['']; 
          teams.forEach((t,ti)=>{ 
            const p=t.players[i]; 
            if(p){ 
              row.push(p.name); 
              row.push(p.absent?'':p.points); 
              row.push(p.absent?'':p.scratches); 
              row.push(p.absent?'':p.palos); 
              row.push(p.absent?'':p.aces); 
            } else { 
              row.push('','','','',''); 
            } 
            if(ti<teams.length-1) row.push(''); 
          });
          ws.getRow(r).values = row;
          let c=2; 
          teams.forEach((t,ti)=>{ 
            const p=t.players[i]; 
            if(p){ 
              for(let j=0;j<5;j++){ 
                const cell=ws.getCell(r, c+j); 
                cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; 
                cell.alignment={horizontal: j===0?'left':'center', vertical:'center'}; 
              } 
            } 
            c += (ti<teams.length-1)?6:5; 
          });
        }

        currentRow += 14;
      });

      if (processedData.length>0){ 
        const tcount=processedData[0].teamOrder.length; 
        const widths=[2.25]; 
        for(let i=0;i<tcount;i++){ 
          widths.push(15,8,10,8,8); 
          if(i<tcount-1) widths.push(6); 
        } 
        widths.push(2.25); // Columna padding final
        ws.columns = widths.map(w=>({width:w})); 
      }

      addFraming(ws, 2.25);
    }

    function generateGpSheet(ws){
      // Recopilar jugadores de todos los grupos
      const allPlayers = {};
      const groups = [];

      processedData.forEach((groupData, groupIndex) => {
        const groupName = Object.keys(groupData.teams)[0]; // GRUPO A, GRUPO B, etc.
        groups.push(groupName);

        groupData.players.forEach((player, playerIndex) => {
          if (!player.absent) {
            if (!allPlayers[player.name]) {
              allPlayers[player.name] = {
                name: player.name,
                team: player.team,
                groups: {},
                gpp: 0
              };
            }
            
            // Calcular puntos GP seg√∫n posici√≥n (15-12-10-8-6-4-3-2-1)
            const gpPoints = [15, 12, 10, 8, 6, 4, 3, 2, 1][playerIndex] || 0;
            allPlayers[player.name].groups[groupName] = {
              pts: player.points,
              pos: playerIndex + 1,
              scr: player.scratches,
              ace: player.aces,
              gpp: gpPoints
            };
            allPlayers[player.name].gpp += gpPoints;
          }
        });
      });

      // Agrupar por equipos y ordenar
      const playersByTeam = {};
      Object.values(allPlayers).forEach(player => {
        if (!playersByTeam[player.team]) playersByTeam[player.team] = [];
        playersByTeam[player.team].push(player);
      });

      // Headers
      ws.getCell(1, 2).value = 'NOMBRE';
      ws.getCell(1, 3).value = `GP${gpNumber}`;
      ws.getCell(1, 4).value = 'PTS';
      ws.getCell(1, 5).value = 'POS';
      ws.getCell(1, 6).value = 'SCR';
      ws.getCell(1, 7).value = 'ACE';

      // Aplicar formato a headers
      for (let col = 2; col <= 7; col++) {
        const cell = ws.getCell(1, col);
        cell.font = { bold: true, size: 11 };
        cell.alignment = { horizontal: 'center' };
        cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
      }

      let currentRow = 2;
      const baseWidthName = NAME_W;
      const numW = 7;
      const sepCols = 1;

      // Para cada equipo
      Object.keys(playersByTeam).forEach((teamName, teamIndex) => {
        const teamPlayers = playersByTeam[teamName];
        teamPlayers.sort((a, b) => b.gpp - a.gpp);

        const baseCol = 2 + teamIndex * (6 + sepCols);
        const colors = COLORES_SUAVES[teamName] || { bg: '#f0f0f0', fg: '#333' };

        // Header del equipo (sin la fila extra que mencionaste)
        const teamCell = ws.getCell(2, baseCol);
        teamCell.value = teamName;
        teamCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.bg.replace('#', 'FF') } };
        teamCell.font = { color: { argb: colors.fg.replace('#', 'FF') }, bold: true, size: 12 };
        teamCell.alignment = { horizontal: 'center' };
        teamCell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };

        // Sub-headers
        const subHeaders = ['NOMBRE', `GP${gpNumber}`, 'PTS', 'POS', 'SCR', 'ACE'];
        subHeaders.forEach((header, idx) => {
          const cell = ws.getCell(3, baseCol + idx);
          cell.value = header;
          cell.font = { bold: true, size: 10 };
          cell.alignment = { horizontal: idx === 0 ? 'left' : 'center' };
          cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });

        // Anchos
        ws.getColumn(baseCol).width = baseWidthName;
        for (let off = 1; off <= 5; off++) {
          ws.getColumn(baseCol + off).width = numW;
        }

        // Datos de jugadores
        let dataRow = 4;
        teamPlayers.forEach(player => {
          ws.getCell(dataRow, baseCol).value = player.name;
          
          // GP${gpNumber} - mantener 0 si es 0
          ws.getCell(dataRow, baseCol + 1).value = player.gpp;
          ws.getCell(dataRow, baseCol + 1).font = { bold: true };

          // PTS, POS, SCR, ACE - mostrar vac√≠o si es 0, excepto POS
          const mainGroup = groups[0]; // Tomar el primer grupo como referencia
          const groupData = player.groups[mainGroup];
          if (groupData) {
            ws.getCell(dataRow, baseCol + 2).value = groupData.pts || '';
            ws.getCell(dataRow, baseCol + 3).value = groupData.pos;
            ws.getCell(dataRow, baseCol + 4).value = groupData.scr || '';
            ws.getCell(dataRow, baseCol + 5).value = groupData.ace || '';
          }

          // Alineaci√≥n
          for (let off = 1; off <= 5; off++) {
            ws.getCell(dataRow, baseCol + off).alignment = { horizontal: 'center' };
            ws.getCell(dataRow, baseCol + off).border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
          }
          
          dataRow++;
        });
      });

      // Marco con padding
      addFraming(ws, 2.25);
    }

    function generateTotalesSheet(ws){
      const playerTotals = {}; 
      const teamTotals = {};
      
      processedData.forEach(match => {
        match.teamOrder.forEach(teamName => {
          if (!teamTotals[teamName]) teamTotals[teamName] = { name:teamName, totalPoints:0,totalPalos:0,totalScratches:0,totalAces:0,totalAsistencia:0,gamesPlayed:0 };
          teamTotals[teamName].totalPoints += match.teams[teamName] || 0;
          const teamPlayers = match.players.filter(p=>p.team===teamName && !p.absent);
          teamTotals[teamName].totalAsistencia += teamPlayers.length;
          teamTotals[teamName].gamesPlayed += 1;
          teamPlayers.forEach(p=>{ 
            teamTotals[teamName].totalPalos += p.palos||0; 
            teamTotals[teamName].totalScratches += p.scratches||0; 
            teamTotals[teamName].totalAces += p.aces||0; 
          });
        });
        
        match.players.forEach(p=>{
          if (!p.absent){
            if (!playerTotals[p.name]) playerTotals[p.name] = { name:p.name, team:p.team, totalPoints:0,totalPalos:0,totalScratches:0,totalAces:0,gamesPlayed:0 };
            const rec = playerTotals[p.name]; 
            rec.team=p.team; 
            rec.totalPoints += p.points||0; 
            rec.totalPalos += p.palos||0; 
            rec.totalScratches += p.scratches||0; 
            rec.totalAces += p.aces||0; 
            rec.gamesPlayed += 1;
          }
        });
      });

      const players = Object.values(playerTotals).map(p=>({ ...p,
        avgPoints: p.gamesPlayed? p.totalPoints/p.gamesPlayed:0,
        avgPalos: p.gamesPlayed? p.totalPalos/p.gamesPlayed:0,
        avgScratches: p.gamesPlayed? p.totalScratches/p.gamesPlayed:0,
        avgAces: p.gamesPlayed? p.totalAces/p.gamesPlayed:0 }));

      const teams = Object.values(teamTotals).map(t=>({ ...t,
        avgPoints: t.gamesPlayed? t.totalPoints/t.gamesPlayed:0,
        avgPalos: t.gamesPlayed? t.totalPalos/t.gamesPlayed:0,
        avgScratches: t.gamesPlayed? t.totalScratches/t.gamesPlayed:0,
        avgAces: t.gamesPlayed? t.totalAces/t.gamesPlayed:0,
        avgAsistencia: t.gamesPlayed? t.totalAsistencia/t.gamesPlayed:0 }));

      function getTeamColors(teamName){ return COLORES_SUAVES[teamName] || { bg:'#f0f0f0', fg:'#333' }; }

      const pBlocks = [
        { title:'PUNTOS',     baseCol:2,  sort:(a,b)=>b.avgPoints-a.avgPoints,       pick:(p)=>[p.totalPoints,p.gamesPlayed,+p.avgPoints.toFixed(1)] },
        { title:'POSTES',     baseCol:7,  sort:(a,b)=>b.avgPalos-a.avgPalos,         pick:(p)=>[p.totalPalos,p.gamesPlayed,+p.avgPalos.toFixed(1)] },
        { title:'SCRATCHES',  baseCol:12, sort:(a,b)=>b.avgScratches-a.avgScratches, pick:(p)=>[p.totalScratches,p.gamesPlayed,+p.avgScratches.toFixed(1)] },
        { title:'ACES',       baseCol:17, sort:(a,b)=>b.avgAces-a.avgAces,           pick:(p)=>[p.totalAces,p.gamesPlayed,+p.avgAces.toFixed(1)] }
      ];

      pBlocks.forEach(b => {
        ws.getCell(1, b.baseCol+1).value = b.title;
        ws.getCell(2, b.baseCol).value = 'NOMBRE';
        ws.getCell(2, b.baseCol+1).value = 'TOT';
        ws.getCell(2, b.baseCol+2).value = 'JUG';
        ws.getCell(2, b.baseCol+3).value = 'AVG';
        const data = [...players].sort(b.sort);
        data.forEach((p, idx)=>{
          const row = idx + 3; 
          const colors = getTeamColors(p.team);
          const nameCell = ws.getCell(row, b.baseCol);
          nameCell.value = p.name; 
          nameCell.font = { color:{ argb: colors.fg.replace('#','FF') } }; 
          nameCell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb: colors.bg.replace('#','FF') } };
          const [tot,gp,avg] = b.pick(p);
          ws.getCell(row, b.baseCol+1).value = tot;
          ws.getCell(row, b.baseCol+2).value = gp;
          ws.getCell(row, b.baseCol+3).value = avg;
        });
      });

      ws.getCell(1, 22).value = '';

      const tBlocks = [
        { title:'PUNTOS',     baseCol:24, sort:(a,b)=>b.avgPoints-a.avgPoints,       pick:(t)=>[t.totalPoints,t.gamesPlayed,+t.avgPoints.toFixed(1)] },
        { title:'POSTES',     baseCol:29, sort:(a,b)=>b.avgPalos-a.avgPalos,         pick:(t)=>[t.totalPalos,t.gamesPlayed,+t.avgPalos.toFixed(1)] },
        { title:'SCRATCHES',  baseCol:34, sort:(a,b)=>b.avgScratches-a.avgScratches, pick:(t)=>[t.totalScratches,t.gamesPlayed,+t.avgScratches.toFixed(1)] },
        { title:'ACES',       baseCol:39, sort:(a,b)=>b.avgAces-a.avgAces,           pick:(t)=>[t.totalAces,t.gamesPlayed,+t.avgAces.toFixed(1)] },
        { title:'ASISTENCIA', baseCol:44, sort:(a,b)=>b.avgAsistencia-a.avgAsistencia, pick:(t)=>[t.totalAsistencia,t.gamesPlayed,+t.avgAsistencia.toFixed(1)] }
      ];

      tBlocks.forEach(b => {
        ws.getCell(1, b.baseCol+1).value = b.title;
        ws.getCell(2, b.baseCol).value = 'EQUIPO';
        ws.getCell(2, b.baseCol+1).value = 'TOT';
        ws.getCell(2, b.baseCol+2).value = 'JUG';
        ws.getCell(2, b.baseCol+3).value = 'AVG';
        const data = [...teams].sort(b.sort);
        data.forEach((t, idx)=>{
          const row = idx + 3; 
          const colors = getTeamColors(t.name);
          const nameCell = ws.getCell(row, b.baseCol);
          nameCell.value = t.name; 
          nameCell.font = { color:{ argb: colors.fg.replace('#','FF') } }; 
          nameCell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb: colors.bg.replace('#','FF') } };
          const [tot,gp,avg] = b.pick(t);
          ws.getCell(row, b.baseCol+1).value = tot;
          ws.getCell(row, b.baseCol+2).value = gp;
          ws.getCell(row, b.baseCol+3).value = avg;
        });
      });

      ws.columns = [
        { width: 2.25 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 3 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 }, { width: 3 },
        { width: 15 }, { width: 8 }, { width: 8 }, { width: 8 },
        { width: 2.25 }
      ];

      addFraming(ws, 2.25);
    }
  </script>
</body>
</html>
