<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Procesador de Logs de Trivial IRC</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .upload-section {
      border: 2px dashed #ddd;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 8px;
      background-color: #fafafa;
    }
    .upload-section:hover {
      border-color: #007bff;
      background-color: #f0f8ff;
    }
    input[type="file"] {
      margin: 20px 0;
    }
    .button {
      background-color: #007bff;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px;
    }
    .button:hover { background-color: #0056b3; }
    .button:disabled { background-color: #ccc; cursor: not-allowed; }
    .results { margin-top: 30px; }
    .team-section { margin-bottom: 30px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .team-header { padding: 15px; font-weight: bold; font-size: 18px; text-align: center; }
    .stats-table { width: 100%; border-collapse: collapse; }
    .stats-table th, .stats-table td { padding: 8px 12px; text-align: center; border: 1px solid #ddd; }
    .stats-table th { background-color: #f8f9fa; font-weight: bold; }
    .player-row { background-color: white; }
    .error { color: #dc3545; background-color: #f8d7da; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .success { color: #155724; background-color: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; }
    .log-info { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Procesador de Logs de Trivial IRC</h1>

    <!-- PROCESO 1: Estad√≠sticas de la Jornada -->
    <div class="upload-section">
      <h3>üìä Estad√≠sticas de la Jornada</h3>
      <p>Sube los logs (.txt) de las partidas de una jornada espec√≠fica</p>
      <input type="file" id="fileInputJornada" accept=".txt" multiple />
      <br />
      <button class="button" onclick="processJornada()" id="processJornadaBtn" disabled>Procesar Jornada</button>
    </div>

    <!-- PROCESO 2: Totales y Medias Liga -->
    <div class="upload-section" style="border-color: #28a745; background-color: #f8fff9;">
      <h3>üèÜ Totales y Medias Liga</h3>
      <p>Sube los Excels (.xlsx) generados de cada jornada para obtener totales acumulados</p>
      <input type="file" id="fileInputTotales" accept=".xlsx" multiple />
      <br />
      <button class="button" onclick="processTotales()" id="processTotalesBtn" disabled style="background-color: #28a745;">Generar Totales Liga</button>
    </div>

    <div id="results" class="results" style="display: none;"></div>

    <div id="downloadSection" style="display: none; text-align: center; margin-top: 30px;">
      <button class="button" onclick="downloadExcel()" id="downloadBtn">üì• Descargar Excel</button>
    </div>
  </div>

  <script>
    const COLORES_EQUIPOS = {
      "FOGUETES": {"bg": "#009F9F", "fg": "#00FF00"},
      "ATIPIK@S": {"bg": "#00FF00", "fg": "#0000FF"},
      "REPESCA@S": {"bg": "#C000C0", "fg": "#00FF00"},
      "DARKSHADOWS": {"bg": "#000000", "fg": "#808080"},
      "TELERINEZ": {"bg": "#000000", "fg": "#00FFFF"},
      "KAMIKAZES": {"bg": "#000000", "fg": "#FF0000"},
      "HARDBE@TS": {"bg": "#000000", "fg": "#FFFF00"},
      "LIDERES": {"bg": "#C000C0", "fg": "#FFFFFF"}
    };

    let processedData = [];
    let fileNames = [];
    let currentProcess = ''; // 'jornada' o 'totales'

    // === Habilitar botones al seleccionar archivos ===
    document.addEventListener('DOMContentLoaded', () => {
      const inJ = document.getElementById('fileInputJornada');
      const inT = document.getElementById('fileInputTotales');
      const bJ = document.getElementById('processJornadaBtn');
      const bT = document.getElementById('processTotalesBtn');
      if (inJ) inJ.addEventListener('change', () => { bJ.disabled = !(inJ.files && inJ.files.length); });
      if (inT) inT.addEventListener('change', () => { bT.disabled = !(inT.files && inT.files.length); });
    });

    function showError(msg) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="error">${msg}</div>`;
      resultsDiv.style.display = 'block';
    }
    function showSuccess(msg) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `<div class="success">${msg}</div>`;
      resultsDiv.style.display = 'block';
    }

    // ========== PROCESO 1: JORNADA (desde logs .txt) ==========
    function processJornada() {
      const files = document.getElementById('fileInputJornada').files;
      if (!files || files.length === 0) return showError("Selecciona al menos un archivo de log");

      processedData = [];
      fileNames = [];
      currentProcess = 'jornada';

      let processed = 0;
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const data = parseLogFile(content); // <‚Äî versi√≥n robusta V1.5 (mantiene formato V1)
            processedData[index] = data;
            fileNames[index] = file.name;
            processed++;
            if (processed === files.length) {
              displayResults(processedData);
              document.getElementById('downloadSection').style.display = 'block';
              showSuccess(`${files.length} archivo${files.length>1?'s':''} de log procesado${files.length>1?'s':''} correctamente`);
            }
          } catch (error) {
            console.error(error);
            showError(`Error procesando ${file.name}: ${error.message}`);
          }
        };
        reader.readAsText(file);
      });
    }

    function displayResults(allData) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      // Info r√°pida
      const info = document.createElement('div');
      info.className = 'log-info';
      let totalTeams = 0, totalPlayers = 0;
      allData.forEach(data => { totalTeams += Object.keys(data.teams).length; totalPlayers += data.players.length; });
      info.innerHTML = `<h3>üìä Informaci√≥n de los Logs</h3>
        <p><strong>Partidas procesadas:</strong> ${allData.length}</p>
        <p><strong>Total de equipos:</strong> ${totalTeams}</p>
        <p><strong>Total de jugadores:</strong> ${totalPlayers}</p>`;
      resultsDiv.appendChild(info);

      // Vista previa con colores de equipo
      allData.forEach((data, matchIndex) => {
        const matchDiv = document.createElement('div');
        matchDiv.style.marginBottom = '40px';

        data.teamOrder.forEach(team => {
          const teamPlayers = data.players.filter(p => p.team === team);
          teamPlayers.sort((a,b) => (b.points||0) - (a.points||0));

          const teamDiv = document.createElement('div');
          teamDiv.className = 'team-section';
          const colors = COLORES_EQUIPOS[team] || { bg: "#ccc", fg: "#000" };
          const header = document.createElement('div');
          header.className = 'team-header';
          header.style.backgroundColor = colors.bg;
          header.style.color = colors.fg;
          header.textContent = `${team} - ${data.teams[team]} puntos`;
          teamDiv.appendChild(header);

          const table = document.createElement('table');
          table.className = 'stats-table';
          table.innerHTML = `
            <thead>
              <tr><th>Nick</th><th>Puntos</th><th>Scratches</th><th>Palos</th><th>Aces</th></tr>
            </thead><tbody></tbody>`;
          const tbody = table.querySelector('tbody');

          teamPlayers.forEach(p => {
            const row = document.createElement('tr');
            row.className = 'player-row';
            row.innerHTML = `<td style="text-align:left">${p.name}</td>
                             <td>${p.absent ? '' : p.points}</td>
                             <td>${p.absent ? '' : p.scratches}</td>
                             <td>${p.absent ? '' : p.palos}</td>
                             <td>${p.absent ? '' : p.aces}</td>`;
            tbody.appendChild(row);
          });

          teamDiv.appendChild(table);
          matchDiv.appendChild(teamDiv);
        });

        resultsDiv.appendChild(matchDiv);
      });

      resultsDiv.style.display = 'block';
    }

    // ========== PROCESO 2: Totales (desde Excels .xlsx de jornadas) ==========
    async function processTotales() {
      const files = document.getElementById('fileInputTotales').files;
      if (!files || files.length === 0) return showError("Selecciona al menos un archivo Excel (.xlsx)");

      processedData = [];
      fileNames = [];
      currentProcess = 'totales';

      let processed = 0;
      Array.from(files).forEach(async (file, index) => {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const workbook = new ExcelJS.Workbook();
          await workbook.xlsx.load(arrayBuffer);

          const worksheet = workbook.getWorksheet("Estad√≠sticas");
          if (!worksheet) { showError(`El archivo ${file.name} no tiene hoja "Estad√≠sticas"`); return; }

          const matchData = extractDataFromExcel(worksheet);
          processedData.push(...matchData);
          fileNames.push(file.name);
          processed++;
          if (processed === files.length) {
            displayTotalesOnlyResults();
            document.getElementById('downloadSection').style.display = 'block';
            showSuccess(`${fileNames.length} archivo${fileNames.length>1?'s':''} de jornada procesado${fileNames.length>1?'s':''} correctamente`);
          }
        } catch (err) {
          console.error(err);
          showError(`Error procesando ${file.name}: ${err.message}`);
        }
      });
    }

    function displayTotalesOnlyResults() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      let totalMatches = 0;
      const allPlayers = new Set();

      processedData.forEach(matchData => {
        totalMatches++;
        matchData.players.forEach(p => allPlayers.add(p.name));
      });

      const info = document.createElement('div');
      info.className = 'log-info';
      info.innerHTML = `<h3>üèÜ Totales Liga Procesados</h3>
        <p><strong>Jornadas procesadas:</strong> ${fileNames.length}</p>
        <p><strong>Partidas totales:</strong> ${totalMatches}</p>
        <p><strong>Jugadores √∫nicos:</strong> ${allPlayers.size}</p>
        <p><em>Se generar√° Excel con totales acumulados de toda la liga</em></p>`;
      resultsDiv.appendChild(info);
      resultsDiv.style.display = 'block';
    }

    // ======== Extracci√≥n desde Excel de jornada (hoja "Estad√≠sticas") ========
    function extractDataFromExcel(worksheet) {
      const matches = [];
      let currentRow = 1;
      while (currentRow <= worksheet.rowCount) {
        const row = worksheet.getRow(currentRow);
        if (row.getCell(2).value === "Puntos" && row.getCell(3).value === "Scratches") {
          const matchData = extractSingleMatch(worksheet, currentRow);
          if (matchData) matches.push(matchData);
          currentRow += 14; // avanzar al siguiente bloque
        } else {
          currentRow++;
        }
      }
      return matches;
    }

    function extractSingleMatch(worksheet, startRow) {
      try {
        const teamRow = worksheet.getRow(startRow + 1);
        const teams = {}; const teamOrder = []; const players = [];
        let col = 1;
        while (col <= teamRow.cellCount) {
          const teamName = teamRow.getCell(col).value;
          const teamPoints = teamRow.getCell(col + 1).value;
          if (teamName && typeof teamName === 'string' && typeof teamPoints === 'number') {
            teams[teamName] = teamPoints; teamOrder.push(teamName);
          }
          col += 6; // 5 columnas + 1 separador
        }

        for (let i = 0; i < 10; i++) {
          const row = worksheet.getRow(startRow + 2 + i);
          col = 1;
          teamOrder.forEach(teamName => {
            const playerName = row.getCell(col).value;
            const playerPoints = row.getCell(col + 1).value;
            const playerAces = row.getCell(col + 4).value;
            const playerScr = row.getCell(col + 3).value;
            const playerPalos = row.getCell(col + 2).value;
            if (playerName && typeof playerName === 'string') {
              const absent = (playerPoints === null || playerPoints === undefined || playerPoints === '');
              players.push({
                name: playerName.toUpperCase(),
                team: teamName,
                points: absent ? null : (playerPoints||0),
                scratches: absent ? 0 : (playerScr||0),
                palos: absent ? 0 : (playerPalos||0),
                aces: absent ? 0 : (playerAces||0),
                absent
              });
            }
            col += 6;
          });
        }

        return { teams, teamOrder, players };
      } catch (e) { console.error('extractSingleMatch error', e); return null; }
    }

    // ========== Generaci√≥n de Excel (misma hoja, colores conservados) ==========
    async function downloadExcel() {
      try {
        const wb = new ExcelJS.Workbook();

        // Hoja √∫nica "Estad√≠sticas" con TODAS las partidas una debajo de otra
        const ws = wb.addWorksheet("Estad√≠sticas");
        let currentRow = 1;

        processedData.forEach((matchData, matchIndex) => {
          const teams = matchData.teamOrder.map(teamName => {
            const players = matchData.players.filter(p => p.team === teamName);
            players.sort((a,b) => {
              if (a.absent && !b.absent) return 1;
              if (!a.absent && b.absent) return -1;
              return (b.points || 0) - (a.points || 0);
            });
            return {
              name: teamName,
              points: matchData.teams[teamName],
              players,
              colors: COLORES_EQUIPOS[teamName] || { bg: "#CCCCCC", fg: "#000000" }
            };
          });

          // Totales por equipo (para la fila de cabecera de cada bloque)
          const teamTotals = teams.map(team => {
            const totals = { scratches: 0, palos: 0, aces: 0 };
            team.players.forEach(p => { if (!p.absent) { totals.scratches+=p.scratches; totals.palos+=p.palos; totals.aces+=p.aces; } });
            return totals;
          });

          // Fila de encabezado de columnas (por equipo)
          const generalHeaderRow = [];
          teams.forEach((team, index) => {
            generalHeaderRow.push('');
            generalHeaderRow.push("Puntos");
            generalHeaderRow.push("Scratches");
            generalHeaderRow.push("Palos");
            generalHeaderRow.push("Aces");
            if (index < teams.length - 1) generalHeaderRow.push('');
          });
          ws.getRow(currentRow).values = generalHeaderRow;

          // Fila con nombre del equipo + puntos + totales de stats
          const teamTotalRow = [];
          teams.forEach((team, index) => {
            teamTotalRow.push(team.name);
            teamTotalRow.push(team.points);
            teamTotalRow.push(teamTotals[index].scratches);
            teamTotalRow.push(teamTotals[index].palos);
            teamTotalRow.push(teamTotals[index].aces);
            if (index < teams.length - 1) teamTotalRow.push('');
          });
          ws.getRow(currentRow + 1).values = teamTotalRow;

          // Formato (colores, bordes, alineaci√≥n) igual al V1
          let col = 1;
          teams.forEach((team, teamIndex) => {
            for (let i = 0; i < 5; i++) {
              const cell = ws.getCell(currentRow, col + i);
              cell.alignment = { horizontal: i===0?"left":"center", vertical: "center" };
              cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
              if (i === 0) {
                cell.value = team.name;
                cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: team.colors.bg.replace("#","FF") } };
                cell.font = { color: { argb: team.colors.fg.replace("#","FF") }, bold: true, size: 14 };
              } else if (i === 1) {
                cell.font = { bold: true, size: 12 };
              } else {
                cell.font = { bold: false, size: 12 };
              }
            }
            col += (teamIndex < teams.length - 1) ? 6 : 5;
          });

          // Jugadores (10 filas)
          for (let i = 0; i < 10; i++) {
            const playerRowNumber = currentRow + 2 + i;
            const row = [];
            teams.forEach((team, teamIndex) => {
              const player = team.players[i];
              if (player) {
                row.push(player.name);
                row.push(player.absent ? '' : player.points);
                row.push(player.absent ? '' : player.scratches);
                row.push(player.absent ? '' : player.palos);
                row.push(player.absent ? '' : player.aces);
              } else {
                row.push('', '', '', '', '');
              }
              if (teamIndex < teams.length - 1) row.push('');
            });
            ws.getRow(playerRowNumber).values = row;

            let c = 1;
            teams.forEach((team, teamIndex) => {
              const hasPlayer = !!team.players[i];
              if (hasPlayer) {
                for (let j = 0; j < 5; j++) {
                  const cell = ws.getCell(playerRowNumber, c + j);
                  cell.border = { top:{style:"thin"}, left:{style:"thin"}, bottom:{style:"thin"}, right:{style:"thin"} };
                  if (j === 0) { cell.alignment = { horizontal: "left", vertical: "center" }; cell.font = { bold: false }; }
                  else { cell.alignment = { horizontal: "center", vertical: "center" }; }
                }
              }
              c += (teamIndex < teams.length - 1) ? 6 : 5;
            });
          }

          currentRow += 14; // siguiente bloque debajo
        });

        // ====== Tambi√©n se puede agregar aqu√≠ la hoja de Totales si tu V1 ya la generaba ======
        generarHojaTotalesDesdeProcessedData(wb, processedData);

        // Descargar
        const buffer = await wb.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'TrivialIRC_'+fechaYmdHms()+'.xlsx';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e); showError('Error al generar el Excel: '+e.message);
      }
    }

    // ---- Totales a partir de processedData (igual filosof√≠a V1) ----
    function generarHojaTotalesDesdeProcessedData(wb, matches) {
      const ws = wb.addWorksheet('Totales Liga');

      // Acumular por jugador y por equipo
      const byPlayer = new Map();
      const byTeam = new Map();
      const ensureTeam = (t)=>{ if (!byTeam.has(t)) byTeam.set(t,{games:0, wins:0, draws:0, losses:0, points:0, aces:0, scratches:0, palos:0, scoPuntos:0, scoScratches:0}); return byTeam.get(t); };

      matches.forEach(match => {
        const teamNames = match.teamOrder;
        const teamA = ensureTeam(teamNames[0]);
        const teamB = ensureTeam(teamNames[1]);
        // puntos de equipo del bloque
        const Apts = match.teams[teamNames[0]]; const Bpts = match.teams[teamNames[1]];
        teamA.games++; teamB.games++;
        if (Apts>Bpts){ teamA.wins++; teamB.losses++; } else if (Apts<Bpts){ teamB.wins++; teamA.losses++; } else { teamA.draws++; teamB.draws++; }
        if (Apts>Bpts){ teamA.scoPuntos+=3; teamB.scoPuntos+=1; } else if (Apts<Bpts){ teamB.scoPuntos+=3; teamA.scoPuntos+=1; } else { teamA.scoPuntos+=2; teamB.scoPuntos+=2; }

        const sum = {A:{scr:0, pal:0, ace:0}, B:{scr:0, pal:0, ace:0}};
        match.players.forEach(p => {
          if (!byPlayer.has(p.name)) byPlayer.set(p.name,{team:p.team, games:0, points:0, aces:0, scratches:0, palos:0});
          const rec = byPlayer.get(p.name); rec.team=p.team; if (!p.absent){ rec.games++; rec.points+=p.points; rec.aces+=p.aces; rec.scratches+=p.scratches; rec.palos+=p.palos; }
          if (!p.absent) {
            if (p.team===teamNames[0]){ sum.A.scr+=p.scratches; sum.A.pal+=p.palos; sum.A.ace+=p.aces; }
            else { sum.B.scr+=p.scratches; sum.B.pal+=p.palos; sum.B.ace+=p.aces; }
          }
        });
        if (sum.A.scr>sum.B.scr){ teamA.scoScratches+=3; teamB.scoScratches+=1; } else if (sum.A.scr<sum.B.scr){ teamB.scoScratches+=3; teamA.scoScratches+=1; } else { teamA.scoScratches+=2; teamB.scoScratches+=2; }
        const ta = ensureTeam(teamNames[0]); const tb = ensureTeam(teamNames[1]);
        ta.points += Apts; tb.points += Bpts; ta.aces += sum.A.ace; tb.aces += sum.B.ace; ta.scratches += sum.A.scr; tb.scratches += sum.B.scr; ta.palos += sum.A.pal; tb.palos += sum.B.pal;
      });

      // Pintar totales por jugador
      ws.getRow(1).values = ['Nick','Equipo','PJ','Pts','Aces','Scr','Palos'];
      for (let c=1;c<=7;c++){ const cell=ws.getCell(1,c); cell.font={bold:true}; cell.alignment={horizontal:'center',vertical:'middle'}; cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }
      let r = 2;
      const playersSorted = Array.from(byPlayer.entries()).sort((a,b)=> b[1].points - a[1].points || a[0].localeCompare(b[0],'es',{sensitivity:'base'}));
      playersSorted.forEach(([nick,rec])=>{
        ws.getRow(r).values = [nick, rec.team, rec.games, rec.points, rec.aces, rec.scratches, rec.palos];
        for (let c=1;c<=7;c++){ const cell=ws.getCell(r,c); cell.alignment={horizontal: c<=2?'left':'center',vertical:'middle'}; cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }
        r++;
      });

      // Resumen de equipos
      const ws2 = wb.addWorksheet('Resumen Equipos');
      ws2.getRow(1).values = ['Equipo','PJ','G','E','P','Pts (sum)','Aces','Scr','Palos','SCO Pts','SCO Scr'];
      for (let c=1;c<=11;c++){ const cell=ws2.getCell(1,c); cell.font={bold:true}; cell.alignment={horizontal:'center',vertical:'middle'}; cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }
      let r2=2; Array.from(byTeam.entries()).sort((a,b)=> a[0].localeCompare(b[0],'es',{sensitivity:'base'})).forEach(([team,rec])=>{
        ws2.getRow(r2).values = [team, rec.games, rec.wins, rec.draws, rec.losses, rec.points, rec.aces, rec.scratches, rec.palos, rec.scoPuntos, rec.scoScratches];
        for (let c=1;c<=11;c++){ const cell=ws2.getCell(r2,c); cell.alignment={horizontal:'center',vertical:'middle'}; if(c===1) cell.alignment.horizontal='left'; cell.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; }
        r2++;
      });
    }

    // ========= Utilidades =========
    function fechaYmdHms(d = new Date()) {
      const p = n => String(n).padStart(2, '0');
      return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
    }

    // ======= Parser robusto (manteniendo formato V1) =======
    function parseLogFile(content) {
      const lines = content.split('\n').map(l => l.trim()).filter(Boolean);
      const teamStart = lines.findIndex(l => l.includes('CLASIFICACION EQUIPOS'));
      const playerStart = lines.findIndex(l => l.includes('CLASIFICACION INDIVIDUAL'));
      if (teamStart === -1 || playerStart === -1) throw new Error("Secciones no encontradas");

      // ---- Equipos (robusto: nombre con espacios + puntos al final) ----
      const teams = {}; const teamOrder = [];
      for (let i = teamStart + 1; i < playerStart; i++) {
        const m = /^(.*?)\s+(-?\d+)\s*$/.exec(lines[i]);
        if (!m) continue;
        const team = m[1].trim(); const points = parseInt(m[2], 10);
        teams[team] = points; teamOrder.push(team);
      }

      // ---- Jugadores ----
      const players = [];
      for (let i = playerStart + 1; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split(/\s+/); if (parts.length < 2) continue;
        const name = parts[0]; const points = parseInt(parts[1], 10);
        const player = {
          name: name.toUpperCase(),
          points: line.includes('NO ESTUVO PRESENTE') ? null : points,
          aces: parseInt((line.match(/Aces:\s*(\d+)/) || [0, 0])[1],10),
          scratches: parseInt((line.match(/Scr:\s*(\d+)/) || [0, 0])[1],10),
          palos: parseInt((line.match(/Palos:\s*(\d+)/) || [0, 0])[1],10),
          absent: line.includes('NO ESTUVO PRESENTE')
        };
        players.push(player);
      }
      if (!players.length) throw new Error('No se detectaron l√≠neas de jugadores');

      const normalize = s => (s||'').toString().trim().toUpperCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'');
      const cmp = (a,b) => normalize(a).localeCompare(normalize(b), 'es', {sensitivity:'base', numeric:true});
      const teamNames = Object.keys(teams).sort(cmp);
      let index=0; let lastName = players[0].name; players[0].team = teamNames[0] || 'SinEquipo';
      for (let i=1;i<players.length;i++){ const p = players[i]; if (cmp(p.name,lastName) < 0) index++; p.team = teamNames[Math.min(index, teamNames.length-1)] || 'SinEquipo'; lastName = p.name; }

      return { teams, teamOrder: teamOrder.sort((a,b)=>teams[b]-teams[a]), players };
    }
  </script>
</body>
</html>
